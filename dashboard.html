<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Dashboard - Certificate Tracker</title>
  <link rel="manifest" href="./manifest.json">
  <meta name="theme-color" content="#4f46e5">
  <style>
    :root{
      --bg:#f4f6ff;
      --card:#ffffff;
      --text:#0f172a;
      --muted:#64748b;
      --brand:#4f46e5;
      --brand2:#4338ca;
      --danger:#ef4444;
      --warn:#f59e0b;
      --border:#e5e7eb;
      --shadow: 0 18px 45px rgba(15,23,42,.12);
      --radius: 18px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      color:var(--text);
      background: radial-gradient(1200px 600px at 20% 10%, #e7e9ff, transparent 60%),
                  radial-gradient(1000px 500px at 80% 20%, #e9f6ff, transparent 55%),
                  var(--bg);
      padding:22px;
    }
    .wrap{max-width:1100px;margin:0 auto}
    .top{
      background:var(--card);
      border:1px solid var(--border);
      border-radius:24px;
      box-shadow: var(--shadow);
      padding:18px 18px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:14px;
    }
    .brand{
      display:flex; gap:10px; align-items:flex-start;
    }
    .brand h1{margin:0;font-size:26px;line-height:1.1}
    .brand p{margin:4px 0 0 0;color:var(--muted);font-size:13px}
    .actions{display:flex; gap:10px; align-items:center; flex-wrap:wrap}
    .btn{
      border:1px solid var(--border);
      background:#0b1220;
      color:white;
      padding:10px 14px;
      border-radius:14px;
      font-weight:700;
      cursor:pointer;
    }
    .btn.secondary{background:white;color:var(--text)}
    .btn.secondary:hover{background:#f8fafc}
    .btn:hover{filter:brightness(.97)}
    .grid{
      margin-top:18px;
      display:grid;
      grid-template-columns: 1fr;
      gap:18px;
    }
    .panel{
      background:var(--card);
      border:1px solid var(--border);
      border-radius:24px;
      box-shadow: var(--shadow);
      padding:18px;
    }
    .panel h2{margin:0 0 12px 0}
    .small{color:var(--muted); font-size:13px}
    .list{display:grid; gap:12px; margin-top:12px}
    .item{
      border:1px solid var(--border);
      border-radius:18px;
      padding:14px;
      display:flex;
      justify-content:space-between;
      gap:12px;
      align-items:center;
      background:#fff;
    }
    .left strong{display:block;font-size:16px}
    .left .meta{margin-top:4px;color:var(--muted);font-size:13px;line-height:1.35}
    .badge{
      display:inline-flex; gap:8px; align-items:center;
      padding:6px 10px;
      border-radius:999px;
      font-weight:800;
      font-size:12px;
      border:1px solid;
      white-space:nowrap;
    }
    .badge.urgent{background:#fee2e2;border-color:#fecaca;color:#991b1b}
    .right{display:flex; gap:10px; align-items:center}
    .btnMini{
      border:none; cursor:pointer;
      padding:10px 12px;
      border-radius:12px;
      font-weight:800;
      background:#eef2ff;
      color:#1e293b;
    }
    .btnMini:hover{filter:brightness(.98)}
    .btnMini.danger{background:#fee2e2;color:#991b1b}
    .formGrid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:12px;
      margin-top:12px;
    }
    label{font-size:13px;color:var(--muted);display:block;margin:2px 0 6px}
    input{
      width:100%;
      padding:11px 12px;
      border:1px solid var(--border);
      border-radius:12px;
      outline:none;
      font-size:14px;
      background:white;
    }
    input:focus{border-color:#c7d2fe; box-shadow:0 0 0 4px rgba(79,70,229,.12)}
    .full{grid-column:1/-1}
    .formActions{display:flex; gap:10px; margin-top:12px}
    .primary{
      background:var(--brand);
      color:white;
      border:none;
      padding:11px 14px;
      border-radius:12px;
      font-weight:800;
      cursor:pointer;
    }
    .primary:hover{background:var(--brand2)}
    .toast{
      position:fixed;
      right:18px;
      bottom:18px;
      background:#0b1220;
      color:white;
      padding:12px 14px;
      border-radius:14px;
      box-shadow: var(--shadow);
      display:none;
      font-weight:700;
      font-size:13px;
      max-width: min(420px, 92vw);
    }
    .modalBackdrop{
      position:fixed; inset:0;
      background:rgba(15,23,42,.45);
      display:none;
      align-items:center;
      justify-content:center;
      padding:18px;
    }
    .modal{
      width:min(640px, 94vw);
      background:white;
      border-radius:20px;
      border:1px solid var(--border);
      box-shadow: var(--shadow);
      padding:16px;
    }
    .modalTop{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      margin-bottom:10px;
    }
    .modalTop h3{margin:0;font-size:18px}
    .close{
      border:none;background:#f1f5f9;border-radius:12px;padding:8px 10px;cursor:pointer;font-weight:800
    }
    .kv{margin-top:8px; color:#1f2937; font-size:14px; line-height:1.5}
    .kv b{color:#0f172a}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="top">
      <div class="brand">
        <div style="font-size:26px;line-height:1">ðŸ“‹</div>
        <div>
          <h1>Certificate Expiration Tracker</h1>
          <p>Dashboard shows only certificates expiring in <b>â‰¤ 7 days</b>. Reminders are fixed at <b>30</b> & <b>7</b> days.</p>
        </div>
      </div>
      <div class="actions">
        <button class="btn secondary" id="toAll">All Certificates</button>
        <button class="btn" id="logout">Logout</button>
      </div>
    </div>

    <div class="grid">

      <div class="panel">
        <h2>Urgent (â‰¤ 7 days)</h2>
        <div class="small">Tap a certificate to view details and send the urgent reminder email.</div>
        <div class="list" id="urgentList"></div>
        <div class="small" id="emptyUrgent" style="display:none;margin-top:10px;">No urgent certificates yet.</div>
      </div>

      <div class="panel">
        <h2>Add Certificate</h2>
        <div class="small">Doctor Name is required. Type is removed. Reminders are fixed automatically.</div>

        <div class="formGrid">
          <div>
            <label>Certificate Name *</label>
            <input id="cName" placeholder="e.g., BLS, CPR, IELTS" />
          </div>
          <div>
            <label>Doctor Name *</label>
            <input id="cDoctor" placeholder="Doctor name" />
          </div>
          <div>
            <label>Expiration Date *</label>
            <input id="cDate" type="date" />
          </div>
          <div>
            <label>Email Address *</label>
            <input id="cEmail" type="email" placeholder="email@example.com" />
          </div>
        </div>

        <div class="formActions">
          <button class="primary" id="addBtn">Add Certificate</button>
          <button class="btnMini danger" id="resetBtn" type="button">Clear</button>
        </div>

      </div>

    </div>
  </div>

  <div class="toast" id="toast"></div>

  <div class="modalBackdrop" id="mb">
    <div class="modal">
      <div class="modalTop">
        <h3 id="mTitle">Certificate</h3>
        <button class="close" id="mClose">âœ•</button>
      </div>
      <div id="mBody" class="kv"></div>
      <div style="display:flex; gap:10px; margin-top:14px; flex-wrap:wrap">
        <button class="primary" id="sendUrgent">Send Urgent Email</button>
        <button class="btnMini danger" id="deleteOne">Delete</button>
      </div>
    </div>
  </div>

<script>
  // ---------- Auth ----------
  if (sessionStorage.getItem('ct_logged_in') !== '1') {
    window.location.href = './index.html';
  }

  // ---------- Storage ----------
  const KEY = 'ct_certs_v1';

  function readCerts(){
    try { return JSON.parse(localStorage.getItem(KEY) || '[]'); }
    catch { return []; }
  }
  function writeCerts(list){
    localStorage.setItem(KEY, JSON.stringify(list));
  }
  function uid(){
    return 'c_' + Math.random().toString(16).slice(2) + Date.now().toString(16);
  }

  // ---------- Date helpers ----------
  function daysLeft(isoDate){
    const today = new Date();
    today.setHours(0,0,0,0);
    const d = new Date(isoDate + 'T00:00:00');
    const diff = d - today;
    return Math.ceil(diff / (1000*60*60*24));
  }
  function formatISOToMDY(iso){
    // show as M/D/YYYY like your screenshot
    const d = new Date(iso + 'T00:00:00');
    const m = d.getMonth()+1;
    const day = d.getDate();
    const y = d.getFullYear();
    return m + '/' + day + '/' + y;
  }

  // ---------- Badge logic ----------
  function badgeFor(dl){
    if (dl <= 7) return {text: `Urgent (${dl}d)`, cls:'urgent'};
    if (dl <= 30) return {text: `First Alert (${dl}d)`, cls:'first'};
    return null;
  }

  // ---------- Toast ----------
  const toast = document.getElementById('toast');
  let toastT = null;
  function showToast(msg){
    toast.textContent = msg;
    toast.style.display = 'block';
    clearTimeout(toastT);
    toastT = setTimeout(()=> toast.style.display='none', 2600);
  }

  // ---------- Email ----------
  function buildEmail(cert, dl){
    const isUrgent = dl <= 7;
    const subject = isUrgent
      ? `ðŸš¨ Urgent Reminder: ${cert.name} Expiring Soon`
      : `âš ï¸ First Reminder: ${cert.name} Expiring Soon`;

    const lines = [
      "Hello,",
      "",
      `This is a ${isUrgent ? "urgent reminder" : "first reminder"} that "${cert.name}" will expire soon:`,
      "",
      `ðŸ“… Expiration Date: ${formatISOToMDY(cert.expiry)}`,
      `â³ Days Remaining: ${dl} day${dl===1?"":"s"}`,
      `ðŸ‘©â€âš•ï¸ Doctor: ${cert.doctor}`,
      "",
      isUrgent
        ? "Please renew as soon as possible."
        : "Note: You will receive an urgent reminder 7 days before expiration.",
      "",
      "This reminder was prepared by Certificate Expiration Tracker"
    ];
    return { subject, body: lines.join("\n") };
  }

  function openMail(cert){
    const dl = daysLeft(cert.expiry);
    const {subject, body} = buildEmail(cert, dl);
    const href = `mailto:${encodeURIComponent(cert.email)}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
    window.location.href = href;

    // Mark as "prepared"
    cert.mailPreparedAt = new Date().toISOString();
    cert.mailPreparedKind = (dl <= 7) ? 'urgent' : (dl <= 30 ? 'first' : 'none');
    saveOne(cert);

    showToast("Email draft opened âœ…");
    renderUrgent();
  }

  function saveOne(updated){
    const list = readCerts();
    const idx = list.findIndex(x => x.id === updated.id);
    if (idx >= 0){
      list[idx] = updated;
      writeCerts(list);
    }
  }

  // ---------- Render urgent list ----------
  const urgentList = document.getElementById('urgentList');
  const emptyUrgent = document.getElementById('emptyUrgent');

  let modalCertId = null;

  function renderUrgent(){
    const list = readCerts()
      .map(c => ({...c, dl: daysLeft(c.expiry)}))
      .filter(c => c.dl <= 7)
      .sort((a,b)=> a.dl - b.dl);

    urgentList.innerHTML = '';
    emptyUrgent.style.display = list.length ? 'none' : 'block';

    list.forEach(c=>{
      const div = document.createElement('div');
      div.className = 'item';
      const prepared = c.mailPreparedAt ? ' â€¢ Email prepared' : '';
      div.innerHTML = `
        <div class="left">
          <strong>${escapeHtml(c.name)}</strong>
          <div class="meta">Expiry: ${escapeHtml(formatISOToMDY(c.expiry))} â€¢ Email: ${escapeHtml(c.email)} â€¢ Doctor: ${escapeHtml(c.doctor)}${prepared}</div>
        </div>
        <div class="right">
          <span class="badge urgent">ðŸš¨ Urgent (${c.dl}d)</span>
          <button class="btnMini" type="button">View / Send Email</button>
        </div>
      `;
      div.querySelector('button').addEventListener('click', ()=> openModal(c.id));
      urgentList.appendChild(div);
    });
  }

  function escapeHtml(s){
    return String(s || '').replace(/[&<>"']/g, (m)=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[m]));
  }

  // ---------- Modal ----------
  const mb = document.getElementById('mb');
  const mTitle = document.getElementById('mTitle');
  const mBody = document.getElementById('mBody');
  const mClose = document.getElementById('mClose');
  const sendUrgent = document.getElementById('sendUrgent');
  const deleteOne = document.getElementById('deleteOne');

  function openModal(id){
    const cert = readCerts().find(c => c.id === id);
    if (!cert) return;

    modalCertId = id;
    const dl = daysLeft(cert.expiry);

    mTitle.textContent = cert.name;
    mBody.innerHTML = `
      <div><b>Doctor:</b> ${escapeHtml(cert.doctor)}</div>
      <div><b>Email:</b> ${escapeHtml(cert.email)}</div>
      <div><b>Expiration Date:</b> ${escapeHtml(formatISOToMDY(cert.expiry))}</div>
      <div><b>Days Remaining:</b> ${dl}</div>
      <div><b>Reminder:</b> ${dl <= 7 ? "Urgent (7 days)" : "Not urgent"}</div>
      ${cert.mailPreparedAt ? `<div style="margin-top:10px;color:#16a34a;font-weight:800">âœ… Email prepared</div>` : ``}
    `;

    // only urgent email here (dashboard is urgent list)
    sendUrgent.onclick = ()=> {
      const fresh = readCerts().find(c => c.id === id);
      if (fresh) openMail(fresh);
    };

    deleteOne.onclick = ()=>{
      const list = readCerts().filter(c => c.id !== id);
      writeCerts(list);
      showToast("Deleted âœ…");
      closeModal();
      renderUrgent();
    };

    mb.style.display = 'flex';
  }
  function closeModal(){
    mb.style.display = 'none';
    modalCertId = null;
  }
  mClose.addEventListener('click', closeModal);
  mb.addEventListener('click', (e)=>{ if(e.target === mb) closeModal(); });

  // ---------- Add form ----------
  const cName = document.getElementById('cName');
  const cDoctor = document.getElementById('cDoctor');
  const cDate = document.getElementById('cDate');
  const cEmail = document.getElementById('cEmail');

  function clearForm(){
    cName.value = '';
    cDoctor.value = '';
    cDate.value = '';
    cEmail.value = '';
  }
  document.getElementById('resetBtn').addEventListener('click', clearForm);

  document.getElementById('addBtn').addEventListener('click', ()=>{
    const name = (cName.value||'').trim();
    const doctor = (cDoctor.value||'').trim();
    const expiry = (cDate.value||'').trim();
    const email = (cEmail.value||'').trim();

    if(!name || !doctor || !expiry || !email){
      showToast("Please fill all required fields.");
      return;
    }

    const list = readCerts();
    list.push({
      id: uid(),
      name,
      doctor,
      expiry,
      email,
      createdAt: new Date().toISOString()
    });
    writeCerts(list);
    showToast("Saved âœ…");
    clearForm();
    renderUrgent();
  });

  // ---------- Nav ----------
  document.getElementById('toAll').addEventListener('click', ()=> window.location.href = './certificates.html');
  document.getElementById('logout').addEventListener('click', ()=>{
    sessionStorage.removeItem('ct_logged_in');
    window.location.href = './index.html';
  });

  // Initial render
  renderUrgent();
</script>
</body>
</html>
